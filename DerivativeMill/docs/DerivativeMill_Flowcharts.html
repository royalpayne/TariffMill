<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Derivative Mill - Process & Network Flowcharts</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.6.1/mermaid.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            color: #34495e;
            margin-top: 40px;
            border-left: 4px solid #3498db;
            padding-left: 10px;
        }
        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .mermaid {
            display: flex;
            justify-content: center;
        }
        .description {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        @media print {
            body { background: white; }
            .chart-container { box-shadow: none; border: 1px solid #ddd; }
            h1, h2 { page-break-after: avoid; }
            .chart-container { page-break-inside: avoid; }
        }
    </style>
</head>
<body>
    <h1>üè≠ Derivative Mill - System Documentation</h1>
    
    <h2>1. Application Process Flowchart</h2>
    <div class="description">
        <strong>Overview:</strong> This flowchart shows the complete invoice processing workflow from file import through customs documentation export.
    </div>
    <div class="chart-container">
        <div class="mermaid">
flowchart TD
    subgraph INPUT["üì• INPUT STAGE"]
        A[Start] --> B[Select Invoice File]
        B --> C[Load Excel/CSV File]
        C --> E[Parse Columns]
    end

    subgraph MAPPING["üîó COLUMN MAPPING"]
        E --> F{Mapping Profile Exists?}
        F -->|Yes| G[Load Saved Profile]
        F -->|No| H[Manual Column Mapping]
        G --> I[Map Invoice Columns]
        H --> I
        I --> J[Validate Required Fields]
        J -->|Complete| K[Create Data Frame]
        J -->|Missing Fields| H2[Manual Column Mapping]
        H2 --> J
    end

    subgraph PARTS["üì¶ PARTS LOOKUP"]
        K --> L[Extract Part Numbers]
        L --> M{Part in Database?}
        M -->|Yes| N[Load HTS Code & Origin]
        M -->|No| O[Mark 'Not Found' in 232 Status]
        N --> P[Merge Part Data]
        O --> P
    end

    subgraph TARIFF["üèõÔ∏è SECTION 232 PROCESSING"]
        P --> Q{HTS Code Available?}
        Q -->|Yes| R[Lookup HTS in tariff_232]
        Q -->|No| S[Skip 232 Lookup]
        R --> T{Found in tariff_232?}
        T -->|Yes| U[Get Material & Declaration Code from DB]
        T -->|No| W[No 232 Required]
        U --> X[Combine Results]
        S --> X
        W --> X
    end

    subgraph REVIEW["‚úÖ VERIFICATION"]
        X --> Y[Display in Preview Table]
        Y --> Z{User Review}
        Z -->|Edit Required| ZA[Manual Corrections]
        ZA --> Y
        Z -->|Approved| ZB[Mark Verified]
    end

    subgraph EXPORT["üì§ EXPORT"]
        ZB --> ZD[Generate Customs Workbook]
        ZD --> ZF[Apply Formatting]
        ZF --> ZG[Save to Output Folder]
        ZG --> ZH[Move Input to Processed]
        ZH --> ZI[End]
    end

    style INPUT fill:#e8f5e9
    style MAPPING fill:#e3f2fd
    style PARTS fill:#fff3e0
    style TARIFF fill:#fce4ec
    style REVIEW fill:#f3e5f5
    style EXPORT fill:#e0f2f1
        </div>
    </div>

    <h2>2. Network Architecture - Shared Database Design</h2>
    <div class="description">
        <strong>Overview:</strong> This diagram shows the multi-user network setup with a shared SQLite database on a network drive.
    </div>
    <div class="chart-container">
        <div class="mermaid">
flowchart TB
    subgraph USERS["üë• USER WORKSTATIONS"]
        U1["üñ•Ô∏è User 1 PC<br/>DerivativeMill.exe<br/>QSettings (personal)"]
        U2["üñ•Ô∏è User 2 PC<br/>DerivativeMill.exe<br/>QSettings (personal)"]
        U3["üñ•Ô∏è User 3 PC<br/>DerivativeMill.exe<br/>QSettings (personal)"]
    end

    subgraph CONFIG["‚öôÔ∏è SHARED CONFIGURATION"]
        CF["config.ini<br/>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ<br/>[Database]<br/>path = \\\\server\\share\\derivativemill.db"]
    end

    subgraph NETWORK["üåê NETWORK SHARE"]
        direction TB
        NS["üìÅ \\\\server\\customs_data\\"]
        DB[("üóÑÔ∏è derivativemill.db<br/>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ<br/>‚Ä¢ parts_master<br/>‚Ä¢ tariff_232<br/>‚Ä¢ sec_232_actions<br/>‚Ä¢ mapping_profiles<br/>‚Ä¢ app_config")]
        NS --> DB
    end

    U1 -->|"reads"| CF
    U2 -->|"reads"| CF
    U3 -->|"reads"| CF

    CF -->|"points to"| NS

    U1 <-->|"SQLite Connection<br/>(sequential access)"| DB
    U2 <-->|"SQLite Connection<br/>(sequential access)"| DB
    U3 <-->|"SQLite Connection<br/>(sequential access)"| DB

    style USERS fill:#e3f2fd
    style CONFIG fill:#fff9c4
    style NETWORK fill:#c8e6c9
    style DB fill:#a5d6a7
        </div>
    </div>

    <h2>3. Data Flow - Settings Storage</h2>
    <div class="description">
        <strong>Overview:</strong> Shows how settings are separated between shared (config.ini/database) and personal (QSettings/Registry). Each user has their own personal preferences stored in the Windows Registry, while business data is shared via the SQLite database.
    </div>
    <div class="chart-container">
        <div class="mermaid">
flowchart LR
    subgraph APP["DerivativeMill Application"]
        A[Application Startup]
    end

    subgraph SHARED["üìÑ Shared Settings"]
        B["config.ini<br/>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ<br/>Database Path"]
        B2["SQLite Database<br/>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ<br/>‚Ä¢ Parts Data<br/>‚Ä¢ Tariff Data<br/>‚Ä¢ Mapping Profiles"]
    end

    subgraph PERSONAL["üîê Per-User Settings (QSettings)"]
        C["Theme & Font Size"]
        D["Column Widths"]
        E["Preview Colors<br/>(Steel/Aluminum/etc.)"]
        F["Export Colors"]
        G["Excel Viewer Preference"]
        H["Update Check Preference"]
    end

    subgraph REGISTRY["Windows Registry"]
        R["HKEY_CURRENT_USER\\<br/>Software\\DerivativeMill\\<br/>DerivativeMill"]
    end

    A -->|"Read shared config"| B
    B -->|"Connect to"| B2
    A -->|"Read user prefs"| PERSONAL
    PERSONAL --> R

    style SHARED fill:#fff9c4
    style PERSONAL fill:#e1bee7
    style REGISTRY fill:#ffccbc
        </div>
    </div>

    <h2>4. Database Schema</h2>
    <div class="description">
        <strong>Overview:</strong> Entity relationship diagram showing the shared database tables. Note: Per-user settings (theme, colors, etc.) are stored in the Windows Registry via QSettings, not in this database.
    </div>
    <div class="chart-container">
        <div class="mermaid">
erDiagram
    parts_master {
        TEXT part_number PK
        TEXT description
        TEXT hts_code FK
        TEXT country_origin
        TEXT mid
        TEXT client_code
        REAL steel_ratio
        REAL non_steel_ratio
        TEXT last_updated
    }

    tariff_232 {
        TEXT hts_code PK
        TEXT material
        TEXT classification
        TEXT chapter
        TEXT chapter_description
        TEXT declaration_required
        TEXT notes
    }

    sec_232_actions {
        TEXT tariff_no PK
        TEXT action
        TEXT description
        TEXT advalorem_rate
        TEXT effective_date
        TEXT expiration_date
        TEXT specific_rate
        TEXT additional_declaration
        TEXT note
        TEXT link
    }

    mapping_profiles {
        TEXT profile_name PK
        TEXT mapping_json
        TEXT created_date
    }

    app_config {
        TEXT key PK
        TEXT value
    }

    parts_master ||--o| tariff_232 : "hts_code lookup"
        </div>
    </div>

    <h2>5. Deployment Checklist</h2>
    <div class="chart-container">
        <div class="mermaid">
flowchart TD
    subgraph SETUP["üîß INITIAL SETUP (Admin)"]
        A1[Create Network Share Folder] --> A2[Copy derivativemill.db to Share]
        A2 --> A3[Set Read/Write Permissions]
        A3 --> A4[Create config.ini with DB Path]
    end

    subgraph DEPLOY["üì¶ DEPLOY TO USERS"]
        B1[Copy DerivativeMill.exe] --> B2[Copy config.ini]
        B2 --> B3[Copy Resources Folder]
        B3 --> B4[Create Desktop Shortcut]
    end

    subgraph VERIFY["‚úÖ VERIFICATION"]
        C1[Launch Application] --> C2{Settings > Database Tab}
        C2 --> C3[Verify 'Shared Network' Type]
        C3 --> C4[Verify Correct Path Shown]
        C4 --> C5[Test Parts Lookup]
    end

    SETUP --> DEPLOY --> VERIFY

    style SETUP fill:#bbdefb
    style DEPLOY fill:#c8e6c9
    style VERIFY fill:#fff9c4
        </div>
    </div>

    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            }
        });
    </script>

    <div style="margin-top: 40px; padding: 20px; background: #ecf0f1; border-radius: 8px;">
        <h3>üìã Quick Reference</h3>
        <table style="width: 100%; border-collapse: collapse;">
            <tr style="background: #3498db; color: white;">
                <th style="padding: 10px; text-align: left;">File</th>
                <th style="padding: 10px; text-align: left;">Location</th>
                <th style="padding: 10px; text-align: left;">Purpose</th>
            </tr>
            <tr>
                <td style="padding: 10px; border-bottom: 1px solid #ddd;"><code>DerivativeMill.exe</code></td>
                <td style="padding: 10px; border-bottom: 1px solid #ddd;">Each user's PC</td>
                <td style="padding: 10px; border-bottom: 1px solid #ddd;">Main application executable</td>
            </tr>
            <tr>
                <td style="padding: 10px; border-bottom: 1px solid #ddd;"><code>config.ini</code></td>
                <td style="padding: 10px; border-bottom: 1px solid #ddd;">Next to .exe (same for all users)</td>
                <td style="padding: 10px; border-bottom: 1px solid #ddd;">Shared database path configuration</td>
            </tr>
            <tr>
                <td style="padding: 10px; border-bottom: 1px solid #ddd;"><code>derivativemill.db</code></td>
                <td style="padding: 10px; border-bottom: 1px solid #ddd;">Network share (e.g., \\server\customs\)</td>
                <td style="padding: 10px; border-bottom: 1px solid #ddd;">Shared parts and tariff database</td>
            </tr>
            <tr>
                <td style="padding: 10px; border-bottom: 1px solid #ddd;"><code>Resources/</code></td>
                <td style="padding: 10px; border-bottom: 1px solid #ddd;">Next to .exe</td>
                <td style="padding: 10px; border-bottom: 1px solid #ddd;">Icons, templates, reference files</td>
            </tr>
            <tr>
                <td style="padding: 10px; border-bottom: 1px solid #ddd;"><code>User Settings</code></td>
                <td style="padding: 10px; border-bottom: 1px solid #ddd;">Windows Registry<br/>(HKCU\Software\DerivativeMill)</td>
                <td style="padding: 10px; border-bottom: 1px solid #ddd;">Per-user preferences (theme, colors, column widths)</td>
            </tr>
        </table>
    </div>

    <footer style="text-align: center; margin-top: 40px; color: #7f8c8d;">
        <p>Derivative Mill v0.90 - Customs Documentation Processing System</p>
        <p>Generated: <script>document.write(new Date().toLocaleDateString())</script></p>
    </footer>
</body>
</html>
